# claude-history 技術レビューメモ

## APIキー管理方針
- 暗号化は行わない（AWS CLI、Stripe CLIと同様の方式）
- 設定ファイルに平文で保存
- ファイルパーミッション600で保護
- 理由：ユーザーホームディレクトリ内の隠しフォルダ（~/.claude/cchistory/）は適切なアクセス制御がされており、多くのCLIツールで採用されている標準的な方式

## Drizzle ORMとsqlite-vecの非互換性

### 確認結果
- Drizzle ORMは現時点でsqlite-vecをサポートしていない
- PostgreSQLのpgvectorは完全サポートされているが、SQLiteのvector拡張は未対応
- VirtualTableの定義機能もDrizzleには存在しない

### 設計への影響
1. **現在の二重管理が必須**
   - Drizzleで通常テーブル（messages）を管理
   - 生SQLでVirtualTable（message_vectors、messages_fts）を管理
   
2. **採用する解決策**
   - 生SQLで統一し、better-sqlite3の型機能で型安全性を確保
   - `db.prepare<Params[], Result>()`で入力・出力の型を明示
   - Drizzle ORMは使用しない（sqlite-vec/FTS5との統合を優先）

## sqlite-vec に関する懸念事項

### 1. 技術的成熟度
- sqlite-vec は比較的新しいプロジェクトで、本番環境での大規模データ（10,000セッション以上）での実績が限定的
- 1536次元のベクトル（OpenAI埋め込み）を効率的に扱えるかの検証が必要

### 2. パフォーマンス面での懸念
- ANNインデックスのサポート状況と実際のパフォーマンス
- 大量のベクトルデータでの検索速度
- インデックスサイズとメモリ使用量

### 3. 互換性
- better-sqlite3 との統合時の安定性
- バージョンアップデート時の後方互換性

### 4. 代替案の検討
- もし sqlite-vec が期待通りに動作しない場合の代替案を準備しておく必要がある
  - 例：別のベクトルDBの使用（Faiss、Qdrant等）
  - 検索精度とパフォーマンスのトレードオフ

## Vercel AI SDK の採用理由
- 他のプロバイダー（Cohere、Anthropic等）への切り替え可能性を考慮
- 統一されたインターフェースで複数のAIプロバイダーに対応可能
- 将来的な拡張性を確保

## 並行処理とメモリ管理
- 現状の数値（並行5、メモリ500MB）は初期値として設定
- 実際の運用で調整可能な設計にする

## テスト戦略の検討事項

### モック戦略
1. **OpenAI APIのモック**
   - MSW (Mock Service Worker) または nock を使用
   - 固定のベクトル値を返すモックレスポンス
   - テスト用の小さな埋め込みベクトル（例：128次元）

2. **SQLiteのテスト**
   - インメモリDBモード（`:memory:`）を使用
   - テストごとに新しいDBインスタンス

3. **sqlite-vec拡張のモック**
   - 拡張なしでもテスト可能な設計
   - ベクトル検索部分は統合テストでのみ実施
   - 単体テストではスタブ化

### 開発効率を上げるテスト設計
- 各機能モジュールに対応するテストファイル配置
- 共通のテストユーティリティ（DB初期化、モックデータ生成）
- CIでの並列テスト実行